<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="../src/fechas.js"></script>
    <title>Ejercicio 2</title>
    <script>
        var persona = null;
        var personas = [];

        //Definicion de clase Persona

        class Persona {
            // Haciendo las variables privadas, se pone una almohadilla (#) delante, pero ademas hay que definirlas
            #nombre = "";
            #apellidos = "";
            #dni = "";
            #fechanac = "";
            #edad = "";

            //para acceder a estas propiedades, se pone siempre this.#propiedad
            //porque si no se pone # es como si estuvieramos llamando a los métodos
            //get o set, dependiendo del contexto
            constructor(nombre, apellidos, dni, fechanac, edad) {
                this.#nombre = nombre;
                this.#apellidos = apellidos;
                this.#dni = dni;
                this.#fechanac = fechanac;
                this.#edad = calcularEdad(fechanac);
                this.numeroAsignaturas = [];
            }

            //ATENCION, SI NO SE UTILIZA THIS.#PROPIEDAD EN UN METODO GET
            ///ES COMO SI LLAMAMOS AL PROPIO METODO GET
            //Y SE TRATARÍA DE UN PROCESO RECURSIVO QUE SE QUEDA EN BUCLE
            get nombre() {
                return this.#nombre;
            }

            set nombre(nombre) {
                this.#nombre = nombre;
            }

            get apellidos() {
                return this.#apellidos;
            }

            set apellidos(apellidos) {
                this.#apellidos = apellidos;
            }

            get dni() {
                return this.#dni;
            }

            set dni(dni) {
                this.#dni = dni;
            }

            get fechanac() {
                return this.#fechanac;
            }

            set fechanac(fechanac) {
                this.#fechanac = fechanac;
            }
            get edad() {
                return this.#edad;
            }

            set edad(edad) {
                this.#edad = edad;
            }

            toString() {
                let cadena = "DNI: " + this.dni + "\nNombre: " + this.apellidos + ", " + this.nombre + "\nNumero de asignaturas: " + this.numeroAsignaturas.length + "\n";
                return cadena;
            }
        }
         //Definimos el metodo de calcularEdad
         function calcularEdad(fechanac) {
                let fecha = dividirFecha(fechanac); //Dividimos la fecha en un array
                let hoy = new Date(); //Cojemos la fecha de hoy
                let edad = hoy.getFullYear() - fecha[2]; //Calculamos la edad restando el año actual y el valor que nos pasan

                if (hoy.getMonth() < fecha[1] - 1) { //Si el mes de hoy es menor que el actual-1 (se pone menos 1 porque los meses son de 0 a 11)
                    edad--; //Quitamos en 1 la edad
                } else { //En caso contrario
                    if (hoy.getMonth() == fecha[1] - 1 && hoy.getDate() < fecha[0]) { //Si tanto el mes y el dia son menores a los datos que nos pasan
                        edad--; //Restamos en 1 la edad
                    }
                }
                return edad; //devolvemos la edad
            }

        function esLetraCorrecta(dni) {
            let letras = "TRWAGMYFPDXBNJZSQVHLCKE"; //Tenemos una cadena con las letras del dni
            let letra = dni[8]; //Sabemos que el dni tiene la letra en la 8va posicion
            let numeros = Number.parseInt(dni.substring(0, 8)); //Parseamos el resto de la cadena a enteros
            let resto = numeros % 23; //Para averiguar si la letra es correcta, hay que sacar el resto de la parte entera
            return (letras[resto] == letra); //Y dependiendo del resto lo comparamos con la letra que nos pasan en la persona
        }

        function validar() {
            let nombre = document.getElementById("nom").value.trim();
            let apellidos = document.getElementById("ape").value.trim();
            let dni = document.getElementById("dni").value.trim();
            let fecha_nac = document.getElementById("fecha_nac").value.trim();

            if (nombre == "") { 
                document.getElementById("nom").style = "background-color: red;";
                alert("El nombre no puede estar vacio");
                return;
            } else {
                document.getElementById("nom").style = "background-color: green;";
            }

            if (apellidos == "") {
                document.getElementById("ape").style = "background-color: red;";
                alert("Los apellidos no pueden estar vacios");
                return;
            } else {
                document.getElementById("ape").style = "background-color: green;";
            }

            if (dni == "") {
                document.getElementById("dni").style = "background-color: red;";
                alert("El dni no puede estar vacio");
                return;
            } else if (!dni.match(/^[0-9]{8}[A-Z]{1}/)) { //El DNI sigue el formato de 8 numeros y 1 letra
                document.getElementById("dni").style = "background-color: red;";
                alert("El dni no coincide con la expresion, asegurate que tenga 8 numeros y 1 letra");
                return;
            } else if (!esLetraCorrecta(dni)) {
                document.getElementById("dni").style = "background-color: red;";
                alert("La letra del DNI no es correcta, asegurate que has escrito tu dni correctamente");
                return;
            } else {
                document.getElementById("dni").style = "background-color: green;";
            }

            if (fecha_nac == "") {
                document.getElementById("fecha_nac").style = "background-color: red;";
                alert("La fecha no puede estar vacia");
                return;
            } else if (fecha_nac.match(/^([1-9]|[12][0-9]|3[01])\/(0[1-9]|1[0-2])\/(\d{4})$/) == null) { //La fecha sigue el formato de dd/mm/aaaa
                document.getElementById("fecha_nac").style = "background-color: red;";
                alert("La fecha debe cumplir el formato dd/mm/aaaa");
                return;
            } else if (!esFecha(fecha_nac)) {
                document.getElementById("fecha_nac").style = "background-color: red;";
                alert("La fecha no es correcta");
                return;
            } else {
                //Si todo va bien, guardamos los datos en persona
                document.getElementById("fecha_nac").style = "background-color: green;";
                if (existeDni(dni)) {
                    document.getElementById("dni").style = "background-color: red;";
                    alert("Este DNI ya existe");
                    return;
                } else {
                persona = new Persona(nombre, apellidos, dni, fecha_nac);
                personas.push(persona);
                alert("Persona creada con exito");
                }
            }
        }

        function matricular() {
            if (personas.length == 0) { //Comprobamos que se crea al menos 1 persona
                alert("No has creado persona");
            } else {
                let dni = prompt("Introduce el dni");
                let matricula = prompt("¿Donde se va a matricular?");
                for (let i = 0; i < personas.length; i++) {
                if (personas[i].dni == dni) { //Recorremos array hasta que sean igualeslos dnis
                    personas[i].numeroAsignaturas.push(matricula); //Ponemos esa asignatura
                }
            }
            }
        }

        function existeDni(dni) {
            let comprobar = personas.map( function(n) {
                return n.dni;
            }).filter(n => n.includes(dni)); //Mapeamos los dnis del array y filtramos si son iguales al que pasamos

            if (comprobar.length == 0) { //Si la longitud es 0 entonces es que no existe
                return false;
            } else {
                return true;
            }

        }

        function mostrar() {
            let texarea = document.getElementById("mostrar");
            for (let i = 0; i < personas.length; i++) {
                texarea.innerHTML += personas[i].toString() + "\n";//Muestra los datos
            }
        }

        function mostrarPorDni() {
            if (personas.length == 0) {
                alert("Crea al menos 1 persona");
            } else {
            let dni = prompt("Introduce el dni");
            for (let i = 0; i < personas.length; i++) {
                if (personas[i].dni == dni) { //Lo mismo que mostrar pero solo muestra cuando el dni es igual
                    document.getElementById("mostrar").innerHTML += personas[i].toString();
                }
            }
            }
        }

        function mostrarPorAsignatura() {
            if (personas.length == 0) {
                alert("Crea al menos 1 persona");
            } else {
                let asig = prompt("Introduce la asingnatura");
                let personasAsig = personas.filter(n => n.numeroAsignaturas == asig); //Filtramos aquellos cuya asignatura sea igual
                document.getElementById("mostrar").innerHTML += personasAsig.toString();
            }
        }

        function mostrarAsignaturasSin() {
            if (persona.length == 0) {
                alert("Crea al menos una persona")
            } else {
                let personasAsig = personas.filter(n => n.numeroAsignaturas.length != 0); //Filtramos por la longitud de las asignaturas sea distinto de 0 (que esten matriculados)
                document.getElementById("mostrar").innerHTML += personasAsig.toString();
            }
        }


    </script>
</head>

<body>
    <label for="nombre">Nombre: </label>
    <br>
    <input type="text" id="nom">
    <br>
    <label for="apellidos">Apellidos: </label>
    <br>
    <input type="text" id="ape">
    <br>
    <label for="dni">Dni: </label>
    <br>
    <input type="text" id="dni">
    <br>
    <label for="fecha_nac">Fecha de Nacimiento: </label>
    <br>
    <input type="text" id="fecha_nac">
    <br>
    <textarea  id="mostrar" cols="30" rows="10"></textarea>
    <button id="validar" onclick="validar()">Guardar y Validar</button>
    <button onclick="matricular()">Matricular Persona</button>
    <button onclick="mostrar()">Mostrar Personas</button>
    <button onclick="mostrarPorDni()">Mostrar persona segun DNI</button>
    <button onclick="mostrarPorAsignatura()">Mostrar persona segun Asignatura</button>
    <button onclick="mostrarAsignaturasSin()">Mostrar personas y Asignaturas sin repetir</button>
</body>

</html>